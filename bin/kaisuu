#!/usr/bin/env ruby
require_relative '../lib/kaisuu/counter.rb'
require 'jdict'
require 'optparse'

BASE_PATH   = ENV["HOME"]
DICT_PATH   = File.join(BASE_PATH, '.dicts')
INDEX_PATH  = DICT_PATH

JDict.configure do |config|
  config.dictionary_path    = DICT_PATH
  config.index_path         = INDEX_PATH
  config.language           = JDict::JMDictConstants::Languages::ENGLISH
  config.num_results        = 50
end

maker = My::CardMaker.new

keep = false
individual = false
context = 2
output = "wordlist.txt"

ARGV.options do |opts|
  opts.on("-i", "--individual", "Make individual decks")   { |val| individual = val }
  opts.on("-k", "--keep", "Keep cards with missing fields") { |val| keep = val  }
  opts.on("-c", "--context=val", Integer, "Sentences to keep surrounding example") { |val| context = val }
  opts.on("-o", "--output=val", "Filename (for single file only)") { |val| output = val }
  opts.parse!
end

cards = []

ARGV.each do |a|
  cards += maker.generate_cards(a, keep, individual, context)
  if individual
    File.open("#{a}.txt", 'w') { |file| file.write(cards.join("\n")) }
    cards = []
  end
end

File.open(output, 'w') { |file| file.write(cards.join("\n")) } unless individual
